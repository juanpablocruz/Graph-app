<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Graph API</title>
    <link rel="stylesheet" href="iconos.min.css">
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="color_input.css">
    <link rel="icon" type="image/png" href="icono.ico"/>
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.7.4.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js" ></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.js"></script>


    <script>
        var data, tipo;
        var rABS = typeof FileReader !== "undefined" && typeof FileReader.prototype !== "undefined" && typeof FileReader.prototype.readAsBinaryString !== "undefined";
        window.onerror = function(msg, url, ln, cl, err) {
            console.log(err);
            switch(err.message) {
                case "Unexpected token u":
                case "Cannot read property 'color' of undefined":
                    $("#error").css("display","block");

                    $(document).on("click","#error",function() {
                        localStorage.clear();
                        $(this).css("display","none");
                        location.reload();
                    });
                    break
                default:
                    location.reload();
            }
        };
        function xlsxworker(data, cb) {
            var worker = new Worker('js/xlsxworker.min.js');

            worker.onmessage = function(e) {
                switch(e.data.t) {
                    case 'ready': break;
                    case 'e': console.error(e.data.d); break;
                    case 'xlsx': cb(JSON.parse(e.data.d)); break;
                }
            };
            var arr = rABS ? data : btoa(String.fromCharCode.apply(null, new Uint8Array(data)));
            worker.postMessage({d:arr,b:rABS});
        }
        function to_json(workbook) {
            var result = {};
            workbook.SheetNames.forEach(function(sheetName) {
                var roa = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
                if(roa.length > 0){
                    result[sheetName] = roa;
                }
            });
            return result;
        }

        var tarea = document.getElementById('b64data');
        function b64it() {
            var wb = XLSX.read(tarea.value, {type: 'base64'});
            process_wb(wb);
        }

        function process_wb(wb) {
            var output = "";
            output = to_json(wb).Hoja1;

            data = JSON.stringify(output, 2, 2);
            localStorage.data=data;
            tipo = localStorage.chartType;
            $(".loader").toggle();
            _("#graph").display_table(wb.Sheets);
            
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();
            var files = e.dataTransfer.files;
            var i,f;
            for (i = 0, f = files[i]; i != files.length; ++i) {
                var reader = new FileReader();
                var name = f.name;
                reader.onload = function(e) {
                    var data = e.target.result;
                    if(typeof Worker !== 'undefined') {
                        xlsxworker(data, process_wb);
                    } else {
                        var wb;
                        if(rABS) {
                            wb = XLSX.read(data, {type: 'binary'});
                        } else {
                        var arr = String.fromCharCode.apply(null, new Uint8Array(data));
                            wb = XLSX.read(btoa(arr), {type: 'base64'});
                        }
                        process_wb(wb);
                    }
                };
                if(rABS) reader.readAsBinaryString(f);
                else reader.readAsArrayBuffer(f);
            }
        }

        function dragevents(){
            $("#attr-grupos>ul>li").droppable({
                addClasses : false,
                accept: ".data-list-li",
                drop: function(e,ui){
                    $(this).find("ul").append(ui.draggable)
                }
            });
            var oldList,newList,item;
            $(".sortable-group-list > ul").sortable({
                start: function (event, ui) {
                    item = ui.item;
                    newList = oldList = ui.item.parent();
                },
                stop: function (event, ui) {

                // perform action here
                },
                change: function (event, ui) {
                    if (ui.sender) newList = ui.placeholder.parent();
                },
                connectWith: ".sortable-group-list > ul",
                dropOnEmpty: true,
                forceHelperSize: true,
                forcePlaceholderSize: true
            }).disableSelection();
        }
        function handleDragover(e) {
            e.stopPropagation();
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }
        function cargar(data,tipo){
            if(typeof data === "undefined") {
                localStorage.clear();
            }
            else {
            switch (tipo) {
                        case "Tartas":
                            if(typeof data[0] != "undefined" &&
                               Object.keys(data[0]).indexOf("label")>-1){
                                _("#graph").pie({data:data});
                                $("#save").attr("download","Grafico-tarta");
                                changeStep($(".current_step"),"next");
                            }
                            else{
                                localStorage.removeItem(data);
                                alert("error de archivo");
                            }
                            break;
                        case "Barras":
                            _("#graph").bars({data:data});
                            $("#save").attr("download","Grafico-barras");
                            changeStep($(".current_step"),"next");
                            break;
                        case "Históricos":
                            _("#graph").history({data:data});
                            $("#save").attr("download","Grafico-historico");
                            changeStep($(".current_step"),"next");
                            break;
                    }
            }
        }
        function changeStep(obj,dir){
            switch(dir){
                case "prev":
                    $(obj).removeClass("current_step").prev().first().addClass("current_step");
                    break;
                case "next":
                    $(obj).removeClass("current_step").next().first().addClass("current_step");
                    break;
            }
        }
        $(function(){
            if (localStorage.data === "undefined") {
                localStorage.clear();
            }
            var tarea = document.getElementById('b64data');
            var drop = document.getElementById('drop');
            if(drop.addEventListener) {
                drop.addEventListener('dragenter', handleDragover, false);
                drop.addEventListener('dragover', handleDragover, false);
                drop.addEventListener('drop', handleDrop, false);
            }

            if(localStorage.chartType){
                if(localStorage.data){
                    changeStep($(".current_step"),"next");
                     changeStep($(".current_step"),"next");
                }
                else{
                    $(".step-info ul").html("");
                    var iStep = $("<li><div class='halfCircleRight'>"+localStorage.chartType+"</div></li>");
                    iStep.css("z-index",4);
                    $(".step-info ul").append(iStep);
                   changeStep($(".current_step"),"next");
                }
            }

            _("#tipoGrafico nav ul").menu();
            if(localStorage.data){
                if(localStorage.chartType) {
                    data = JSON.parse(localStorage.data);
                    tipo = localStorage.chartType;
                    cargar(data,tipo);
                }
            }

            $(document).on("click","#nuevo-graph",function(){
                $("#output").html("");
                $(".current_step").removeClass("current_step");
                $("#tipoGrafico").addClass("current_step");
            });

            $(document).on("click",".back",function(){
                changeStep($(".current_step"),"prev")
            });

            $(document).on("click","#tipoGrafico nav ul li", function(){
                var tx = $(this).attr("tipo");
                $("nav .active").removeClass("active");
                $(this).addClass("active");
                localStorage.clear();
                sessionStorage.clear();
                $("#controls").html("");
                localStorage.chartType = tx;
                $(".step-info ul").html("");
                var iStep = $("<li><div class='halfCircleRight'>"+tx+"</div></li>");
                    iStep.css("z-index",4);
                    $(".step-info ul").append(iStep);

                _("#barstype nav ul").type_menu();
                changeStep($(this).parent().parent().parent(),"next");
            });

            $(document).on("click","#barstype nav ul li", function(){
                var tx = $(this).attr("tipo");
                $(".step-info ul").html("");

                var istep = $("<li><div class='halfCircleRight'>"+localStorage.chartType+"</div></li>");
                    istep.css("z-index",4);
                    $(".step-info ul").append(istep);

                istep = $("<li><div class='halfCircleRight'>"+tx+"</div></li>");
                istep.css("left","-13px");
                istep.css("z-index","0");
                $(".step-info ul").append(istep);
                changeStep($(this).parent().parent().parent().parent(),"next");
            });

            $(document).on("click","#pie_simple",function(){
                $(".complex_pie").addClass("simple_pie");
                $(".active").removeClass("active");
                $(this).addClass("active");
                pie_mode = "simple";
                localStorage.pie_mode = pie_mode;
            });

            $(document).on("click","#pie_complex",function(){
                $(".complex_pie").removeClass("simple_pie");
                $(".active").removeClass("active");
                $(this).addClass("active");
                pie_mode = "complex";
                localStorage.pie_mode = pie_mode;
            });

            $(document).on("click","#bars_compuesto",function(){
                $(".complex_pie").removeClass("simple_pie");
                $(".active").removeClass("active");
                $(this).addClass("active");
                barras_mode = "compuesto";
                if(localStorage.coloresBarras)
                    localStorage.removeItem("coloresBarras");
                localStorage.barras_mode = barras_mode;
            });

            $(document).on("click","#bars_cols",function(){
                $(".complex_pie").addClass("simple_pie");
                $(".active").removeClass("active");
                $(this).addClass("active");
                barras_mode = "cols";
                if(localStorage.coloresBarras)
                    localStorage.removeItem("coloresBarras");
                localStorage.barras_mode = barras_mode;
            });



            $(document).on("click","#create-group",function(){
                var x = $("<li class='sortable-group-list'><span contenteditable='true' class='grupo_tag complex_pie' val='0'>Grupo</span></li>");
                var ul = $("<ul> </ul>");
                dragevents();
                x.append(ul);


                $("#attr-grupos>ul").append(x);

                $(ul).sortable({
                connectWith: ".sortable-group-list > ul",
                dropOnEmpty: true,
                forceHelperSize: true,
                forcePlaceholderSize: true
                }).disableSelection();
            });

            $(document).on("click",".rearrange-button",function(){
                var ul = $(".data-list-li-holder").parent();
                $(".remove-list-item").toggleClass("icon-reorganizar");
                $(".icon-reorganizar").toggleClass("remove-list-item");
                $(".data-list-li-holder ").toggleClass("data-list-li");
                $(".data-list-element-holder").toggleClass("data-list-element");
                if($(".data-list-element-holder").hasClass("data-list-element"))
                    $(".data-list-element-holder").children().first().attr("contenteditable","false");
                else
                    $(".data-list-element-holder").children().first().attr("contenteditable","true");
            });
            $("#groups-ul").sortable({
                items: ".data-list-li-holder",
                handle: ".data-list-element"
            });
            $(document).on("click",".label-dibujar-check",function(){
                if(!$('#dibujar-check').is(":checked")){
                    localStorage.drawLabels = true;
                }
                else {
                    localStorage.drawLabels = false;
                }
            });
            $(document).on("click",".label-dest-check",function(){
                if(!$('#destacar_check').is(":checked")){
                    localStorage.destacado_bars = true;
                }
                else {
                    localStorage.destacado_bars = false;
                }
            });
            $(document).on("mousedown",".data-list-li",function(){
                $(this).addClass("mousedown");
            });
            $(document).on("mouseup",".data-list-li",function(){
                $(this).removeClass("mousedown");

            });

            $(document).on("click",".remove-list-item",function() {
                $(this).parent().remove();
                 _().saveStep();
            });
            $(document).on("click",".label-separador-check",function(){
                if(!$('#separador-check').is(":checked")){
                    localStorage.separado = true;
                }
                else {
                    localStorage.separado = false;
                }
            });
            $(document).on("change","#fileSelect",function(e){
                var files = ($(this)[0].files);
                var i,f;
                for (i = 0, f = files[i]; i != files.length; ++i) {
                var reader = new FileReader();
                var name = f.name;
                reader.onload = function(e) {
                    var data = e.target.result;
                    if(typeof Worker !== 'undefined') {
                        xlsxworker(data, process_wb);
                    } else {
                        var wb;
                        if(rABS) {
                            wb = XLSX.read(data, {type: 'binary'});
                        } else {
                        var arr = String.fromCharCode.apply(null, new Uint8Array(data));
                            wb = XLSX.read(btoa(arr), {type: 'base64'});
                        }
                        process_wb(wb);
                    }
                };
                if(rABS) reader.readAsBinaryString(f);
                else reader.readAsArrayBuffer(f);
            }
            })
            dragevents();
            function restaurarColores(){
                colores = standard.slice(0);
                cargar(data,tipo);
            }
        });
function undo() {
    _().undoAction();
}

    </script>
    </head>
<body>
    <header><h1>GraphApp</h1></header>
    <div id="content">
<div id="tipoGrafico" class="step current_step">
        <nav>
            <ul>
            </ul>
        </nav>
</div>
<div id="barstype" class="step">
    <section>
        <div class="step-info"><ul></ul></div>
        <nav>
            <ul>
            </ul>
            <div class="back">Volver</div>
        </nav>
        </section>
</div>
<div id="loadData" class="step">
    <section id="tools">
        <div class="step-info"><ul></ul></div>
        <div id="drop"><div class="icon-box-add icono"></div>Arrastra un archivo XLSX<br>
        <input id="fileSelect" type="file" value="Seleccionar archivo" accept=".xlsx">
        </div>
        <div class="back">Volver</div>
        <div id="data-choose">
            <ul class="loader">
                <li></li>
                <li></li>
                <li></li>
            </ul>
            <div id="output"></div>
            <div id="controls"></div>
        </div>

    </section>
    <div id="aside_help">
        <h2>Cómo seleccionar los datos</h2><br>
        <p>Arrastra el archivo al area marcada o selecciónalo.</p><br>
        <h4>Elección de datos</h4>
        <ul>
            <li>En el caso de gráficos de tartas, los datos esperados son de la forma Etiqueta - Valor, con un único valor y sin campos de etiqueta extra. Por tanto si los datos se muestran en una fila las etiquetas y debajo los valores, se elegira una configuración vertical, en cambio, si salen a dos columnas se eligirá horizontal</li>
            <li>En el caso de gráfico de barras e históricos, se esperan datos de la siguiente manera:<br>En el caso de una disposición horizontal: Columna de etiquetas que se mostrarán en el eje horizontal, y tantas columnas como campos se quieran visualizar con la etiqueta del campo en la primera fila y los valores en las siguientes filas.<p>En caso de una disposición vertical, será lo mismo cambiando filas por columnas.</p></li>
        </ul>

    </div>
</div>
    <div id="designer" class="step">
        <aside>
            <section id="tools">
                <div id="buttons">
                <div id="nuevo-graph"><div class='icon-file icono' title="Nuevo"></div><span class="menu-text">Nuevo</span></div>
                <button id="undo" onclick="undo()"><div class='icon-undo icono' title="Deshacer acción"></div><span class="menu-text">Deshacer acción</span></button>
                <div id="save-button">
                    <a id="save" href="" download="grafico" >
                        <div class='icon-download icono' title="Guardar"></div>
                        <span class="menu-text">Guardar</span>
                    </a>
                </div>
                </div>
            </section>
        <menu>
        </menu>
    </aside>
    <main>
        <section id="graph">
        </section>
        <section id="graph-data">
        </section>
    </main>
    </div>
        <div id="error">!</div>
    </div>
    <script src="js/color_input.min.js"></script>
    <script src="js/color.min.js"></script>
    <script src="js/core.min.js"></script>
    <script src="js/excel.min.js"></script>
    <script src="js/jszip.js"></script>
    <script src="js/xlsx.min.js"></script>
    <script src="js/pie.min.js"></script>
    <script src="js/barras.min.js"></script>
    <script src="js/historic.min.js"></script>

</body>
</html>
