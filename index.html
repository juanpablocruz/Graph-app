<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Graph API</title>
    <link rel="stylesheet" href="iconos.css">
    <link rel="stylesheet" href="theme.css">
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.7.4.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js" ></script>
     <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>

    
    <script>
        var data, tipo;
        function xlsworker(data, cb) {
            var worker = new Worker('js/xlsworker.js');
            worker.onmessage = function(e) {
                switch(e.data.t) {
                    case 'ready': break;
                    case 'e': console.error(e.data.d);
                    case 'xls': cb(e.data.d); break;
                }
            };
            worker.postMessage(data);
        }
        function to_json(workbook) {
            var result = {};
            workbook.SheetNames.forEach(function(sheetName) {
                var roa = XLS.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
                if(roa.length > 0){
                    result[sheetName] = roa;
                }
            });
            return result;
        }
        
        function b64it() {
            var cfb = XLS.CFB.read(tarea.value, {type: 'base64'});
            var wb = XLS.parse_xlscfb(cfb);
            process_wb(wb);
        }
        
        function process_wb(wb) {
            var output = "";
            output = to_json(wb).Hoja1;
            data = JSON.stringify(output, 2, 2);
            localStorage.data=data;
            tipo = localStorage.chartType;
            cargar(output,tipo);
        }
        
        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();
            var files = e.dataTransfer.files;
            var i,f;
            for (i = 0, f = files[i]; i != files.length; ++i) {
                var reader = new FileReader();
                var name = f.name;
                reader.onload = function(e) {
                    var data = e.target.result;
                    if(typeof Worker !== 'undefined') {
                        xlsworker(data, process_wb);
                    } else {
                        var cfb = XLS.CFB.read(data, {type: 'binary'});
                        //var arr = String.fromCharCode.apply(null, new Uint8Array(data));
                        //var cfb = XLS.CFB.read(btoa(arr), {type: 'base64'});
                        var wb = XLS.parse_xlscfb(cfb);
                        process_wb(wb);
                    }
                };
                reader.readAsBinaryString(f);
                //reader.readAsArrayBuffer(f);
            }
        }
        function dragevents(){
            $(".data-list-li").draggable({
                addClasses : false,
                revert: true,
            });
            $("#attr-grupos>ul>li").droppable({
                addClasses : false,
                accept: ".data-list-li", 
                drop: function(e,ui){
                    console.log(ui);
                    $(this).find("ul").append(ui.draggable)
                }
            });
        }
        function handleDragover(e) {
            e.stopPropagation();
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }
        function cargar(data,tipo){
            switch (tipo){
                        case "Tartas":
                            if(typeof data[0] != "undefined" && Object.keys(data[0]).indexOf("label")>-1){
                                _("#graph").pie({data:data});
                                changeStep($(".current_step"),"next");
                            }
                            else{
                                localStorage.removeItem(data);
                                alert("error de archivo");
                            }
                            break;
                        case "Barras":
                            _("#graph").bars({data:data});
                            changeStep($(".current_step"),"next");
                            break;
                    }
        }
        function changeStep(obj,dir){
            switch(dir){
                case "prev":
                    $(obj).removeClass("current_step").prev().first().addClass("current_step");
                    break;
                case "next":
                    $(obj).removeClass("current_step").next().first().addClass("current_step");
                    break;
            }
        }
        $(function(){
            var tarea = document.getElementById('b64data');
            var drop = document.getElementById('drop');
            if(drop.addEventListener) {
                drop.addEventListener('dragenter', handleDragover, false);
                drop.addEventListener('dragover', handleDragover, false);
                drop.addEventListener('drop', handleDrop, false);
            }
            if(localStorage.chartType){
                if(localStorage.data){
                    changeStep($(".current_step"),"next");
                }
                else{
                    $("#step-info ul").html("");
                    $("#step-info ul").append("<li><div class='halfCircleRight'>"+localStorage.chartType+"</div></li>");
                   changeStep($(".current_step"),"next");
                }
            }
            _("nav ul").menu();
            if(localStorage.data){
                if(localStorage.chartType) {
                    data = JSON.parse(localStorage.data);
                    tipo = localStorage.chartType;
                    cargar(data,tipo);
                }
            }
            $(document).on("click","#nuevo-graph",function(){
                $(".current_step").removeClass("current_step");
                $("#tipoGrafico").addClass("current_step");
            });
            $(document).on("click",".back",function(){
                changeStep($(this).parent().parent(),"prev")
            });
            $(document).on("click","nav ul li",function(){
                switch($(this).text()){
                    case "Tartas":
                        _("#graph").pie({data:data});
                        break;
                }
            });
            $(document).on("click","nav ul li", function(){
                var tx = $(this).attr("tipo");
                $("nav .active").removeClass("active");
                $(this).addClass("active");
                localStorage.clear();
                localStorage.chartType = tx;
                $("#step-info ul").html("");
                $("#step-info ul").append("<li><div class='halfCircleRight'>"+tx+"</div></li>");
                changeStep($(this).parent().parent().parent(),"next");
            });
            $(document).on("click","#pie_simple",function(){
                $(".complex_pie").addClass("simple_pie");
                pie_mode = "simple";
                localStorage.pie_mode = pie_mode;


            });
            $(document).on("click","#pie_complex",function(){
                $(".complex_pie").removeClass("simple_pie");
                pie_mode = "complex";
                localStorage.pie_mode = pie_mode;
            });
            $(document).on("click","#create-group",function(){
                var x = $("<li><span contenteditable='true' class='grupo_tag complex_pie' val='0'>Grupo</span></li>");
                var ul = $("<ul></ul>");
                x.append(ul);
                $("#attr-grupos>ul").append(x);
                x.droppable({
                addClasses : false,
                accept: ".data-list-li", 
                drop: function(e,ui){
                    console.log(e);
                    $(this).find("ul").append(ui.draggable)
                }
                });
            });
            dragevents();
            function restaurarColores(){
                colores = standard.slice(0);
                cargar(data,tipo);
            }
        });
        

    </script>
    </head>
<body>
    <header><h1>GraphApp</h1></header>

    <div id="content">
<div id="tipoGrafico" class="step current_step">
    <nav>
            <ul>
            </ul>
        </nav>
</div>
<div id="loadData" class="step">

    <section id="tools">
        <div id="step-info"><ul></ul></div>
        <div id="drop"><div class="icon-box-add icono"></div>Arrastra un archivo XLS</div>
        <div class="back">Volver</div>
    </section>
</div>
<div id="designer" class="step">
    <aside>
        <section id="tools">
            <div id="buttons">
            <div id="nuevo-graph"><div class='icon-file icono'></div>Nuevo</div>
            <button id="restaurar_colores" onclick="restaurarColores()"><div class='icon-droplet icono'></div>  Restaurar Colores</button>
            <div id="save"><div class='icon-download icono'></div> Guardar</div>
            </div>

        </section>
        <menu>
        </menu>
    </aside>
    <main>
        <section id="graph">
        </section>
        <section id="graph-data">
        </section>
    </main>
    </div>
        </div>
     <script src="js/color.js"></script>
    <script src="js/core.js"></script>
    <script src="js/xls-min.js"></script>
    <script src="js/pie.js"></script>
    <script src="js/barras.js"></script>
</body>
</html>
