var tartas=1;var pie_mode="simple";"use strict";var fuente_value="Cores";if(localStorage.fuente){fuente_value=localStorage.fuente;}if(!localStorage.pie_mode){localStorage.pie_mode="simple";}else{pie_mode=localStorage.pie_mode;}function draw_action(){var a=[];_().each(document.querySelectorAll(".grupo_tag"),function(e,d){a.push({label:d[e].innerHTML,value:d[e].getAttribute("val"),color:$(d[e].nextSibling).find(".color_selector").attr("value")});});localStorage.grupos=JSON.stringify(a);var b=document.querySelectorAll("#fuente_input")[0].value;localStorage.fuente=b;fuente_value=b;var c=[];_().each(document.querySelectorAll("#attr-grupos ul>li .data-list-element"),function(e,d){values=[];var f=$(d[e]).parent().parent().parent().find("span").text();_().each(d[e].childNodes,function(g,h){if(g==2){values.push(h[g]);}else{values.push(h[g].value);}});if(values[2]){color=$(values[2]).find(".color_selector").attr("value");}else{if(e>=colores.length){colores[(e%colores.length)+2]=new Color($(values[2]).find(".color_selector").attr("value"));if(typeof colores[(e%colores.length)+2]==="undefined"){colores[(e%colores.length)+2]=new Color("#000000");}color=colores[(e%colores.length)+2].hex;}else{colores[e]=new Color($(values[2]).find(".color_selector").attr("value"));if(typeof colores[e]==="undefined"){colores[e]=new Color("#000000");}color=colores[e].hex;}}c[e]={label:values[0],value:parseFloat(values[1]),group:f,color:color};});localStorage.data=JSON.stringify(c);dragevents();_("#graph").pie({data:c});}function create_data_set(o,l){o.innerHTML="";var i=document.createDocumentFragment(),a=document.createElement("DIV"),e=document.createElement("BUTTON"),q=document.createElement("DIV");a.setAttribute("id","data-list");e.setAttribute("id","create-group");if(pie_mode==="simple"){e.className="complex_pie simple_pie";}else{e.className="complex_pie";}e.innerHTML="Añadir Grupo";q.setAttribute("id","attr-grupos");q.className="data-options";var k=document.createElement("UL");q.appendChild(e);if(localStorage.grupos&&localStorage.grupos!="[]"&&pie_mode==="complex"){var h=JSON.parse(localStorage.grupos);_().each(h,function(g,f){var d=document.createElement("LI");d.className="sortable-group-list";if(pie_mode==="simple"){d.innerHTML="<span contenteditable='true' class='grupo_tag complex_pie simple_pie '>"+f[g].label+"</span>";}else{d.innerHTML="<span contenteditable='true' class='grupo_tag complex_pie'>"+f[g].label+"</span>";if(f[g].color!=""){clinpt(d).input(f[g].color);}else{clinpt(d).input(colores[g%colores.length].hex);f[g].color=colores[g%colores.length].hex;}}var r=document.createElement("UL");$(".sortable-group-list > ul").sortable({connectWith:".sortable-group-list > ul",dropOnEmpty:true,forceHelperSize:true,forcePlaceholderSize:true}).disableSelection();_().each(l,function(w){if(l[w].group!==""&&l[w].group===f[g].label){if(l[w]["color"]){v=l[w]["color"];}else{if(w>=colores.length){if(typeof colores[(w%colores.length)+2]==="undefined"){colores[(w%colores.length)+2]=new Color("#000000");}var v=colores[(w%colores.length)+2].hex;}else{if(typeof colores[w]==="undefined"){colores[w]=new Color("#000000");}var v=colores[w].hex;}}var u=document.createElement("LI");u.className="data-list-li";var s=document.createElement("DIV");s.className="data-list-element icon-reorganizar";var y=document.createElement("INPUT");y.type="number";y.value=l[w]["value"];y.className="value";var t=document.createElement("INPUT");t.type="text";t.value=l[w]["label"];t.className="label";var x=document.createElement("DIV");x.className="remove-list-item";s.appendChild(t);s.appendChild(y);clinpt(s).input(v);u.appendChild(s);u.appendChild(x);r.appendChild(u);}});d.appendChild(r);k.appendChild(d);q.appendChild(k);});}else{var p=document.createElement("LI");p.className="sortable-group-list";if(pie_mode=="simple"){p.innerHTML="<span contenteditable='true' class='grupo_tag complex_pie simple_pie' val='0'>Grupo1</span>";}else{p.innerHTML="<span contenteditable='true' class='grupo_tag complex_pie' val='0'>Grupo1</span>";}var m=document.createElement("UL");_().each(l,function(t,g){if(l[t]["color"]){s=l[t]["color"];}else{if(t>=colores.length){var s=colores[(t+2)%colores.length].hex;}else{var s=colores[t].hex;}}var r=document.createElement("LI");r.className="data-list-li";var d=document.createElement("DIV");d.className="data-list-element icon-reorganizar";var v=document.createElement("INPUT");v.type="number";v.value=l[t]["value"];v.className="value";var f=document.createElement("INPUT");f.type="text";f.value=l[t]["label"];f.className="label";var u=document.createElement("DIV");u.className="remove-list-item";d.appendChild(f);d.appendChild(v);clinpt(d).input(s);r.appendChild(d);r.appendChild(u);m.appendChild(r);$(".sortable-group-list > ul").sortable({start:function(w,x){item=x.item;newList=oldList=x.item.parent();},stop:function(w,x){},change:function(w,x){if(x.sender){newList=x.placeholder.parent();}},connectWith:".sortable-group-list > ul",dropOnEmpty:true});});p.appendChild(m);k.appendChild(p);q.appendChild(k);}var n=document.createElement("DIV");n.className="data-options";n.setAttribute("id","options-bars");var j=document.createElement("DIV");j.innerHTML="<span>Fuente: </span>";var c=document.createElement("INPUT");c.type="text";c.setAttribute("id","fuente_input");c.setAttribute("value",fuente_value);j.appendChild(c);n.appendChild(j);var b=document.createElement("BUTTON");b.type="submit";b.innerHTML="Dibujar<div class='icon-pencil icono'></div> ";b.className="draw_button";b.addEventListener("click",draw_action,false);q.appendChild(b);i.appendChild(q);i.appendChild(n);a.appendChild(i);o.appendChild(a);dragevents();}_.prototype.pie=function(a){var b=this.id;_().canvas(this.e[0],function(){this.data_content=document.querySelectorAll("#graph-data")[0];this.canvas=document.querySelectorAll(b+" canvas")[0];this.addPieTools();this.drawPie(this.canvas,a.data);clinpt().loadFunctions();});};_.prototype.pie_type_menu=function(){var a=Array.prototype.slice.call(this.e);var b=document.createElement("LI");b.innerHTML="Compuesto<div class='icon-spinner2 icono' title='Gráfico compuesto'></div>";b.setAttribute("id","pie_complex");b.setAttribute("tipo","Compuesto");var c=document.createElement("LI");c.innerHTML="Gráfico simple<div class='icon-spinner icono' title='Gráfico simple'></div>";c.setAttribute("id","pie_simple");c.setAttribute("tipo","Simple");(a).forEach(function(d){d.innerHTML="";d.appendChild(b);d.appendChild(c);});return this;};_.prototype.addPieTools=function(d){var e=document.querySelectorAll("menu")[0];e.innerHTML="";var b=document.createDocumentFragment();var a=document.createElement("DIV");a.innerHTML="<div class='icon-spinner2 icono' title='Gráfico compuesto'></div><span class='menu-text'>Gráfico compuesto</span>";if(pie_mode=="complex"){a.className="active menu-button";}else{a.className="menu-button";}a.setAttribute("id","pie_complex");var g=document.createElement("DIV");if(pie_mode=="simple"){g.className="active menu-button";}else{g.className="menu-button";}g.innerHTML="<div class='icon-spinner icono' title='Gráfico simple'></div><span class='menu-text'>Gráfico simple</span>";g.setAttribute("id","pie_simple");b.appendChild(g);b.appendChild(a);e.appendChild(b);var c=document.querySelectorAll("#graph-data")[0];var b=document.createDocumentFragment();var a=document.createElement("DIV");a.setAttribute("id","attributes-pannel");b.appendChild(a);c.appendChild(b);};_.prototype.draw=function(e,b,f){var a=0;var d=Array();_().each(e,function(g){a+=e[g]["value"];});_().each(e,function(h){if(localStorage.data&&JSON.parse(localStorage.data)[h]["color"]&&f){var g=new Color(JSON.parse(localStorage.data)[h]["color"]);}else{if(!f&&pie_mode=="complex"&&localStorage.grupos){var k=JSON.parse(localStorage.grupos)[h]["color"];if(k===""){var g=colores[h];}else{var g=new Color(k);}}else{if(h>=colores.length){var g=colores[(h%colores.length)+2];}else{var g=colores[h];}}}var j=(e[h]["value"]*100/a)*(Math.PI*2/100);d.push({porcentaje:j,color:g});});for(var c=0;c<e.length;c++){this.drawPieSegment(this.ctx,c,d,b);}if(f){for(var c=0;c<e.length;c++){this.writePieText(this.ctx,c,d,b);}}else{for(var c=0;c<e.length;c++){this.drawPieGroupText(this.ctx,c,d,b+130);}}};_.prototype.drawPie=function(d,g){this.data=g;create_data_set(this.data_content,g);this.ctx=d.getContext("2d");var c=0;if(pie_mode=="complex"&&localStorage.grupos){this.grupos=JSON.parse(localStorage.grupos);var b=this.grupos;var e=[];var f=0;_().each(this.grupos,function(h,j){_().each(g,function(i){if(g[i].group==b[h].label){f+=g[i].value;}});j[h].value=Math.round(f*100)/100;if(f>0){e.push({value:f,label:b[h].label,color:b[h].color});}f=0;});this.draw(e,180,false);c=180;localStorage.grupos=JSON.stringify(e);}else{c=200;}var a=new Kinetic.Text({x:d.width-20,y:d.height-5,text:"Fuente: "+fuente_value,fontSize:15,fontFamily:"infotext,Helvetica,arial,InfoTextBook",fontStyle:"italic",fill:"#7B796C",rotationDeg:-90});_.layer.add(a);this.draw(g,c-20,true);};_.prototype.sumTo=function(b,d){var e=0;for(var c=0;c<d;c++){e+=b[c]["porcentaje"];}return e;};_.prototype.drawPieSegment=function(c,g,h,a){var l=(this.sumTo(h,g));var f=h[g]["porcentaje"];var j=l+f;var d="black";try{d=h[g%h.length]["color"].hex;}catch(k){console.log("Error accediendo al color "+g);}if(typeof h[g]["color"]==="undefined"){localStorage.clear();}var b=new Kinetic.Shape({drawFunc:function(e){var m=Math.floor(e.canvas.width/2);var i=Math.floor(e.canvas.height/2);radius=a;e.beginPath();e.moveTo(m,i);e.arc(m,i,radius,l,j,false);e.closePath();e.fillStrokeShape(this);},fill:d,stroke:"#FFF",strokeWidth:1});_.layer.add(b);_.layer.draw();};_.prototype.drawPieGroupText=function(c,s,a,m){var q=Math.floor(c.canvas.width/2);var p=Math.floor(c.canvas.height/2);radius=m+20;var e;if(a[s%a.length]["color"].lab.l<65){e="#FFF";}else{e="#333";}var f=(this.sumTo(a,s));var n=a[s]["porcentaje"]-0.35;var l=(f+n/2);var j=Math.sin(l)/2;var k=2*Math.cos(l)/3;c.font='16px "Mic 32 New Rounded",mic32newrd';var o=c.measureText(this.grupos[s]["label"]).width;c.fillStyle="#FFF";var b=(Math.round(10*((a[s]["porcentaje"]*180/Math.PI)*100/360))/10);if(b>100){b=100;}var d=new Kinetic.Group({draggable:true,dragBoundFunc:function(A,w){var v=c.canvas.width/2;var r=(c.canvas.height/2);m=radius-20;if(typeof w!="undefined"){var i=v-w.offsetX;var z=r-w.offsetY;if((i*i)+(z*z)>(m*m)){t.setFill("#333");}else{t.setFill(e);}}_.layer.draw();return A;},id:"pie_text_"+s,name:"label"});var g=q+(k*radius);if(g>q*2){g=(q*2)-50;}var h=new Kinetic.Rect({x:g,y:p+(j*radius),width:o+22,height:20,fill:"#000"});var u=new Kinetic.Text({x:g+5,y:p+(j*radius),text:this.grupos[s]["label"],fontSize:16,fontFamily:"'Mic 32 New Rounded',mic32newrd",fill:"#fff",padding:2,paddingLeft:-5});var t=new Kinetic.Text({x:g,y:p+(j*radius)+24,fontSize:12,fontFamily:"'Mic 32 New Rounded',mic32newrd",text:b+"%",fill:e,padding:1});d.add(h);d.add(u);d.add(t);_.layer.add(d);_.layer.draw();};_.prototype.writePieText=function(d,A,b,q){var z=Math.floor(d.canvas.width/2);var x=Math.floor(d.canvas.height/2);radius=q+20;var g;try{if(b[A%b.length]["color"].lab.l<65){g="#FFF";}else{g="#333";}}catch(D){g="#333";}var j=(this.sumTo(b,A));var s=b[A]["porcentaje"]-0.35;var p=(j+s/2);var l=Math.sin(p)/2;var m=2*Math.cos(p)/3;d.font='16px "Mic 32 New Rounded",mic32newrd';var u=d.measureText(this.data[A]["label"]).width;d.fillStyle="#FFF";var f=new Kinetic.Group({draggable:true,dragBoundFunc:function(I,w){var t=d.canvas.width/2;var r=(d.canvas.height/2);q=radius-20;if(typeof w!="undefined"){var i=t-w.offsetX;var H=r-w.offsetY;if((i*i)+(H*H)>(q*q)){B.setFill("#333");}else{B.setFill(g);}}_.layer.draw();return I;},id:"pie_text_"+A,name:"label"});var u=d.measureText(this.data[A]["label"]).width;var n=this.data[A]["label"];var c="",k=0,y=80,v=110,a=0,C=1;var G=0;_().each(n.split(" "),function(e,i){k=d.measureText(i[e]).width;if(G<a){G=a;}if((a+k)>y){if((a+k)>v){c+="\n"+i[e]+" ";if(e!=i.length-1){a=0;}else{a=y;}C++;}else{c+=i[e]+" ";a+=k;}}else{c+=i[e]+" ";a+=k;}});if(C>1){u=G;}var o=20*C;var h=new Kinetic.Rect({x:z+(m*radius),y:x+(l*radius),width:u+22,height:o,fill:"#000"});var F=new Kinetic.Text({x:z+(m*radius)+5,y:x+(l*radius),text:c,fontSize:16,fontFamily:"'Mic 32 New Rounded',mic32newrd",fill:"#fff",padding:2,paddingLeft:-5});var B=new Kinetic.Text({x:z+(m*radius),y:x+(l*radius)+o+4,fontSize:12,fontFamily:"'Mic 32 New Rounded',mic32newrd",text:(Math.round(10*((b[A]["porcentaje"]*180/Math.PI)*100/360))/10)+"%",fill:g,padding:1});f.add(h);f.add(F);f.add(B);_.layer.add(f);var E=_.layer.find(".label");E.forEach(function(e){e.setZIndex(50);});_.layer.draw();};
