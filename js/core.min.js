var modules=[];var direccion="";var error=["","1: JSON.parse ha recibido una variable indefinida ","2: Se esperaba un número, se encontró texto","3: Se esperaba un número, se encontró Infinity","4: División por cero"];var colores=[new Color("#d21f17"),new Color("#d3cdc7"),new Color("#ad9172"),new Color("#4293af"),new Color("#cea072"),new Color("#82afc1"),new Color("#867c73"),new Color("#e2ddd8")];var colores_barras=[colores[3],colores[0],colores[2],colores[4],colores[1]];var colores_alpha=["rgba(0,0,0,0)",colores[3],colores[2],colores[4],colores[1],colores[0]];var Memory={memoria:[],config:{max:3},fields:[],log:function(a){console.log(a);},each:function(b,d){for(var c=0;c<b.length;c++){d(b[c],c,b,this);}},dump:function(){this.each(this.memoria,function(e,b,g,f){f.log(e);});},save:function(a){if(this.memoria.length==this.config.max){this.memoria.shift();}this.memoria.push(a);this.each(this.fields,function(f,d,c,b){localStorage[f]=b.memoria[b.memoria.length-1][f];});sessionStorage.memory=JSON.stringify(this.memoria);},load:function(){if(this.memoria.length>1){this.memoria.pop();return this.memoria[this.memoria.length-1];}else{return -1;}},parse:function(b){try{return JSON.parse(b);}catch(a){return b;}},init:function(a){this.fields=a;try{if(sessionStorage.memory){this.memoria=this.parse(sessionStorage.memory);}}catch(b){}}};function _(a){if(window===this){return new _(a);}switch(typeof a){case"string":this.id=a;Memory.init(["data","output","current","ordenacion","coloresBarras"]);this.alreadySaved=false;this.e=document.querySelectorAll(a);break;}return this;}Array.prototype.minVal=function(){var a=Infinity;_().each(this,function(c,b){if(a==Infinity||this[c]<a){a=b[c];}});return a;};_.prototype={get:function(a){return this;},each:function(c,b){for(var a=0;a<c.length;a++){b.call(this,a,c);}},checkModules:function(){if(typeof(tartas)!="undefined"){var b=document.createDocumentFragment();var a=document.createElement("LI");a.setAttribute("tipo","Tartas");a.innerHTML="Tartas<div class='icon-pie icono'></div> ";b.appendChild(a);modules.push(b);}if(typeof(barras)!="undefined"){var b=document.createDocumentFragment();var a=document.createElement("LI");a.setAttribute("tipo","Barras");a.innerHTML="Barras<div class='icon-bars2 icono'></div> ";b.appendChild(a);modules.push(b);}if(typeof(historic)!="undefined"){var b=document.createDocumentFragment();var a=document.createElement("LI");a.setAttribute("tipo","Históricos");a.innerHTML="Históricos<div class='icon-stats icono'></div> ";b.appendChild(a);modules.push(b);}return this;},menu:function(){this.checkModules();var a=Array.prototype.slice.call(this.e);modules.forEach(function(b){(a).forEach(function(c){c.appendChild(b);});});return this;},type_menu:function(){switch(localStorage.chartType){case"Tartas":this.pie_type_menu();break;case"Barras":this.bars_type_menu();break;case"Históricos":this.history_type_menu();break;}return this;},draw:function(a){_.layer.add(a);_.layer.draw();},drawLabel:function(g,f,l,m,j,d,h,e){var i=new Kinetic.Group({draggable:true,id:"group_label",name:"label"});var k=new Kinetic.Text({x:g,y:f+2,fontSize:12,fontFamily:"Open Sans",text:d,fill:j,padding:h});var a=this.ctx.font;this.ctx.font="12px 'Open Sans'";var b=this.ctx.measureText(d).width;var c=new Kinetic.Rect({x:g,y:f,width:b+5,height:l,fill:m});this.ctx.font=a;i.add(c);i.add(k);e.add(i);return this;},canvas:function(c,g){var a=370;var d=380;this.stage=new Kinetic.Stage({container:c,width:a,height:d});c.style.background="#fff";_.layer=new Kinetic.Layer();var f=this.stage.getWidth()/2-75;var e=this.stage.getHeight()/2-25;var b=this.stage;document.getElementById("save").addEventListener("click",function(i){var j=document.getElementsByTagName("canvas")[0];j.style.background="#fff";var h=_().canvasToImage(j,"#fff");this.href=(h);},false);this.stage.add(_.layer);if(modules.length==0){this.drawLabel(f,e,150,25,"rgba(0,0,0,0.7)","#fff","No hay Módulos",_.layer);}_.layer.draw();g.call(this);},canvasToImage:function(b,i){var d=b.cloneNode(true);var j=b.width;var e=b.height;var g=d.getContext("2d");_().each(document.getElementsByTagName("canvas"),function(k,h){g.drawImage(h[k],0,0);});var c;if(i){c=g.getImageData(0,0,j,e);var f=g.globalCompositeOperation;g.globalCompositeOperation="destination-over";g.fillStyle=i;g.fillRect(0,0,j,e);}var a=d.toDataURL("image/jpeg");if(i){g.clearRect(0,0,j,e);g.putImageData(c,0,0);g.globalCompositeOperation=f;}return a;},getInterval:function(b,d){try{if(isNaN(b)||isNaN(d)){throw error[2];}var c=Math.round(b/d);var a=c.toString().length;var f=Math.pow(10,a-1);var g=parseInt(c/f);return parseInt(g*f);}catch(h){console.log("Error"+h);return -1;}},getMinValue:function(){var f=Infinity;for(var d=0;d<this.data.length;d++){for(var b=1;b<Object.keys(this.data[0]).length;b++){try{if(isNaN(this.data[d][Object.keys(this.data[d])[b]])){throw error[2];}if(this.data[d][Object.keys(this.data[d])[b]]<f){f=this.data[d][Object.keys(this.data[d])[b]];}}catch(h){console.log("Error"+h);}}}try{if(f===Infinity){throw error[3];}var a=f.toString().length;var c=Math.pow(10,a-1);var g=parseInt(f/c);var f=g*c;return parseInt(f);}catch(h){console.log("Error"+h);}return -1;},getStep:function(a,b){var d=this.getInterval(a,b);var c=this.ctx.canvas.height-20;var g=0;try{if(d==0){throw error[4];}g=Math.floor((c)/(a/d));}catch(f){console.log("Error"+f);}return{val:g,label:d};},createBarsVerticalAxis:function(i,k,b){if(barras_mode!="cols"){var o=i;var d=this.getInterval(o,k);this.ceil=((((o+d*2)/d)-2)*d);}else{var o=100;var d=20;this.ceil=((((o+d*2)/d)-2)*d);}this.step=d;var n=this.ctx;var s=new Kinetic.Text({x:n.canvas.width-15,y:n.canvas.height-20,text:"Fuente: "+fuente_value,fontSize:13,fontFamily:"infotext,InfoTextBook,Helvetica,arial",fontStyle:"italic",fill:"#7B796C",rotationDeg:-90});_.layer.add(s);var a=new Kinetic.Text({x:n.canvas.width-(n.measureText("Unidad: "+unidad_value).width+15),y:1,text:"Unidad: "+unidad_value,fontSize:13,fontFamily:"infotext,InfoTextBook,Helvetica,arial",fontStyle:"italic",fill:"#7B796C"});_.layer.add(a);var q=n.canvas.height-20;var m=0;try{if(d==0||o/d==0){throw error[4];}m=Math.floor((q)/(o/d));}catch(r){console.log("Error"+r);}var t=0;n.font="12px 'Mic 32 New Rounded',mic32newrd,arial";var c=0;var j;var f=this.getMinValue(this.data);var l=0;var g={bajo:false,step:d,numero:0,origen:0};if(b=="historico"&&(f-(2*d)>=0||f<0)){g.bajo=true;g.numero=parseInt(f/d);g.origen=f;l=f;d=this.getInterval(o,k);if(f<0){l=-d;}else{l=d*parseInt(f/d);}}this.origen=l;var p=new Kinetic.Shape({drawFunc:function(h){for(var u=l;u<o-(d/2)+l;u+=d){var e=u.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".");c=q-(m*t);if(e.length>3){e=e.substring(0,e.length-4);}h.fillText(e,0,c-5);h.beginPath();h.moveTo(0,c);h.lineTo(h.canvas.width-20,c);h.closePath();h.lineWidth=1;h.stroke();t++;}},id:"axis"});_.layer.add(p);_.layer.draw();return g;},saveStep:function(){var a=new Array();var b;var c;$("#output tr").each(function(e,d){a.push(new Array());$(d).find("td").each(function(g,f){a[e].push($(f).text());});});if(localStorage.ordenacion){b=localStorage.ordenacion;}else{b="";}if(localStorage.coloresBarras){c=localStorage.coloresBarras;}else{c="";}Memory.save({data:localStorage.data,output:JSON.stringify(a),current:$(".current_step").attr("id"),ordenacion:b,coloresBarras:c});},undoAction:function(){var b="";var c=[];var a=Memory.load();if(a!=-1){$(".current_step").removeClass("current_step");$("#"+a.current).addClass("current_step");switch(a.current){case"designer":c=Memory.parse(a.data);console.log(c);b=localStorage.chartType;localStorage.data=JSON.stringify(c);switch(b){case"Tartas":_("#graph").pie({data:c});break;case"Barras":if(a.ordenacion!=""){localStorage.ordenacion=a.ordenacion;}if(a.coloresBarras!=""){localStorage.coloresBarras=a.coloresBarras;}_("#graph").bars({data:c});break;case"Históricos":_("#graph").history({data:c});break;}break;case"loadData":this.loadOutput(a.output);$(".loader").toggle();break;}columna=false;fila=false;}},loadOutput:function(e){var d=Memory.parse(e);var b=$("<table></table>");d.forEach(function(l,k){var m=$("<tr></tr>");d[k].forEach(function(j,i){$(m).append("<td class='dato drop'><div>"+d[k][i]+"</div></td>");});$(b).append(m);});$("#output").html(b);var a=$("<div id='body-output'></div>");$(a).append("<span id='info_dir'>Sentido de datos<sup>?</sup></span>: <div id='abajo'><img src='arriba.jpg'></div><div id='lado'><img src='lado.png'></div>");$(a).append("<input type='radio' name='borrar' id='borrar-fila' class='button borrar-fila' value='Borrar fila'><label for='borrar-fila' id='borrar-fila-label'>Borrar fila</label>");$(a).append("<input type='radio' name='borrar' id='borrar-columna' class='button borrar-columna' value='Borrar columna'><label for='borrar-columna' id='borrar-columna-label'>Borrar columna</label>");$(a).append("<input type='radio' name='borrar' id='borrar-neutro' style='display:none;'>");$(a).append("<div id='undo-container'><button id='undo'><div class='icon icon-undo'></div></button></div>");$(a).append("<div class='button' id='render'>Crear Gráfico</div>");var c=$("<div id='dir_tooltip'>Elige el sentido de los datos:<br/> <b>Horizontal</b> si son: etiqueta - valor o <b>Vertical</b> si son etiqueta - etiqueta y los valores debajo.</div>");$(a).append(c);$("#controls").html(a);$(".loader").toggle();$("#undo").on("click",function(){_().undoAction();});$(".borrar-fila").on("click",function(){if(!fila){fila=true;}else{fila=false;$("#borrar-neutro").prop("checked",true);}columna=false;});$(".borrar-columna").on("click",function(){if(!columna){columna=true;}else{columna=false;$("#borrar-neutro").prop("checked",true);}fila=false;});$("td").on("mouseover",function(j){$(".active").toggleClass("active");if(columna){var i=$(this).index()+1;$("td:nth-child("+i+")").addClass("active");}else{if(fila){$(this).parent().toggleClass("active");}}});$("table").on("click",function(i){$(".active").remove();_().saveStep();});$("#abajo").on("click",function(){direccion="abajo";$(".selection_dir").removeClass("selection_dir");$(this).addClass("selection_dir");});$("#lado").on("click",function(){direccion="lado";$(".selection_dir").removeClass("selection_dir");$(this).addClass("selection_dir");});$("#render").on("click",function(){$("#fileSelect").val("");switch(direccion){case"abajo":g();break;case"lado":f();break;default:console.log("Elige dirección");break;}});var h;$("#info_dir sup").on("mouseover",function(){h=setTimeout(function(){$("#dir_tooltip").show();},250);});$("#info_dir sup").on("mouseout",function(){clearTimeout(h);h=setTimeout(function(){$("#dir_tooltip").hide();},250);});$("#dir_tooltip").on("mouseout",function(){clearTimeout(h);$("#dir_tooltip").hide();});function g(){$(".loader").toggle();var j=new Array();for(var k=0;k<($("tr").first().find("td").length)-1;k++){j.push({});}$("tr").each(function(l,m){$(m).find("td:gt(0)").each(function(i,n){if(!isNaN($(n).text())){j[i][$(m).find("td").first().text()]=Math.round($(n).text()*100)/100;}else{j[i][$(m).find("td").first().text()]=$(n).text();}});});columna=false;fila=false;draw(j);}function f(){$(".loader").toggle();var j=new Array();for(var k=0;k<($("tr").length)-1;k++){j.push({});}$("tr:nth-child(1)").find("td").each(function(l,m){$("tr:gt(0)").find("td:nth-child("+(l+1)+")").each(function(i,n){try{if(isNaN($(n).text())){throw error[2];}j[i][$(m).text()]=Math.round($(n).text()*100)/100;}catch(o){j[i][$(m).text()]=$(n).text();}});});columna=false;fila=false;draw(j);}}};
