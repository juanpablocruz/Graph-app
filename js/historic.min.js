var historic=1;"use strict";var fuente_value="Cores";if(localStorage.fuente){fuente_value=localStorage.fuente;}else{fuente_value="Cores";}var unidad_value="Miles de t";if(localStorage.unidad){unidad_value=localStorage.unidad;}var delim;if(localStorage.leyenda){delim=localStorage.leyenda;}else{delim="Leyenda";}_.prototype.history=function(a){var b=this.id;_().canvas(this.e[0],function(){this.data_content=document.querySelectorAll("#graph-data")[0];this.canvas=document.querySelectorAll(b+" canvas")[0];this.data=a.data;this.printLabels=true;if(localStorage.drawLabels){this.printLabels=localStorage.drawLabels;}this.separado=false;if(localStorage.separado){this.separado=localStorage.separado;if(localStorage.separador_title){this.separador_title=localStorage.separador_title;}else{this.separador_title="Separador";}if(localStorage.separacionList){try{this.listaSeparador=JSON.parse(localStorage.separacionList);if(typeof this.listaSeparador==="string"){this.listaSeparador=[0,0];}}catch(g){console.log(g);this.listaSeparador=[0,0];}}else{this.listaSeparador=[0,0];}}this.colores_grupos=[];for(var c=1;c<Object.keys(this.data[0]).length;c++){var f=Object.keys(this.data[0])[c];var d={grupo:f,color:colores_barras[(c-1)%colores_barras.length].hex};this.colores_grupos.push(d);}if(!localStorage.coloresBarras){localStorage.coloresBarras=JSON.stringify(this.colores_grupos);}else{try{if(typeof localStorage.coloresBarras==="undefined"||localStorage.coloresBarras==="undefined"){throw error[1];}this.colores_grupos=JSON.parse(localStorage.coloresBarras);}catch(g){console.log(g);}}this.addHistTools(a.data);this.drawHist(this.canvas,a.data);});};_.prototype.getMaxValue=function(){var b=0;for(var e=0;e<this.data.length;e++){for(var c=1;c<Object.keys(this.data[0]).length;c++){if(this.data[e][Object.keys(this.data[e])[c]]>b){if(!isNaN(this.data[e][Object.keys(this.data[e])[c]])){b=this.data[e][Object.keys(this.data[e])[c]];}}}}var a=b.toString().split(".")[0].length;var d=Math.pow(10,a-1);var f=parseInt(b/d)+1;var b=f*d;return b;};_.prototype.historyPannel=function(){var J=this.data;var H=document.createDocumentFragment();var h=document.createElement("DIV");h.setAttribute("id","data-container");var B=document.createElement("DIV");B.className="data-options";var c=document.createElement("DIV");c.className="data-options";c.setAttribute("id","options-bars");var v=document.createElement("DIV");v.innerHTML="<span>Fuente: </span>";var d=document.createElement("INPUT");d.type="text";d.setAttribute("id","fuente_input");d.setAttribute("value",fuente_value);var p=document.createElement("DIV");p.innerHTML="<span>Unidad: </span>";var z=document.createElement("INPUT");z.type="text";z.setAttribute("id","unidades_input");z.setAttribute("value",unidad_value);v.appendChild(d);p.appendChild(z);c.appendChild(v);c.appendChild(p);var n=document.createElement("DIV");var l=document.createElement("DIV");var y=document.createElement("input");y.type="checkbox";y.setAttribute("id","dibujar-check");var F=document.createElement("label");F.setAttribute("for","dibujar-check");F.setAttribute("class","label-dibujar-check");F.innerHTML="Dibujar Etiquetas";y.checked=false;if(this.printLabels==="true"){y.checked=true;}n.appendChild(y);n.appendChild(F);var g=document.createElement("input");g.type="checkbox";g.setAttribute("id","separador-check");var E=document.createElement("label");E.setAttribute("for","separador-check");E.setAttribute("class","label-separador-check");E.innerHTML="Dibujar separador";g.checked=false;l.appendChild(g);l.appendChild(E);$(y).on("change",{separado:this.separado,lista:""},this.draw_history_func);$(g).on("change",{separado:this.separado,lista:""},this.draw_history_func);c.appendChild(n);c.appendChild(l);if(this.separado==="true"){var a=document.createElement("div");var r=document.createElement("ul");r.setAttribute("id","separador_ul");g.checked=true;var m=document.createElement("div");m.innerHTML=this.separador_title;m.setAttribute("id","separador_text");m.setAttribute("contenteditable","true");for(var D=0;D<J.length;D++){var k=document.createElement("li");k.className="data-list-separador";k.setAttribute("contenteditable","true");if(!localStorage.separacionList||this.listaSeparador[D]===undefined){k.innerHTML=0;}else{k.innerHTML=this.listaSeparador[D];}r.appendChild(k);}a.appendChild(m);a.appendChild(r);h.appendChild(a);}var u=document.createElement("UL");u.setAttribute("id","groups-ul");for(var A=0;A<Object.keys(J[0]).length;A++){var q=document.createElement("li");var w=document.createElement("DIV");if(Object.keys(J[0])[A]!=delim){w.className="data-list-element-holder";}w.innerHTML="<div contenteditable='true'>"+Object.keys(J[0])[A]+"</div>";if(Object.keys(J[0])[A]!=delim){if(A>0){try{clinpt(w).input(this.colores_grupos[(A-1)%this.colores_grupos.length]["color"]);}catch(I){console.log(I);clinpt(w).input("black");}}}if(A>0){$(q).append("<div class='remove-list-item'></div>");q.className="data-list-li-holder";}else{$(q).append("<div></div>");q.className="data-list-li-year";}q.appendChild(w);var t=document.createElement("ul");for(var D=0;D<J.length;D++){var s=document.createElement("LI");var b=document.createElement("DIV");b.setAttribute("contenteditable","true");b.innerHTML=J[D][Object.keys(J[D])[A]];s.appendChild(b);t.appendChild(s);}q.appendChild(t);u.appendChild(q);}var G=this.separado;if(this.separado=="true"){var o=this.listaSeparador;}var C=document.createElement("BUTTON");C.innerHTML="Dibujar<div class='icon-pencil icono'></div> ";C.className="draw_button";$(C).on("click",{separado:this.separado,lista:o},this.draw_history_func);var x=document.createElement("BUTTON");x.innerHTML="Reordenar<div class='icon-rearrange icono'></div> ";x.className="rearrange-button";B.appendChild(u);h.appendChild(B);h.appendChild(c);H.appendChild(h);H.appendChild(h);H.appendChild(C);H.appendChild(x);return H;};_.prototype.history_type_menu=function(){var b=Array.prototype.slice.call(this.e);var c=document.createElement("LI");c.innerHTML="Gráfico histórico<div class='icon-stats icono' title='Gráfico historico'></div>";c.setAttribute("id","pie_simple");c.setAttribute("tipo","Histórico");var a=document.createElement("LI");a.innerHTML="Gráfico áreas<div class='icon-areas icono' title='Gráfico areas'></div>";a.setAttribute("id","pie_complex");a.setAttribute("tipo","Área");(b).forEach(function(d){d.innerHTML="";d.appendChild(c);d.appendChild(a);});return this;};_.prototype.addHistTools=function(b){var d=document.querySelectorAll("menu")[0];d.innerHTML="";var e=document.createElement("DIV");e.innerHTML="<div class='icon-stats icono' title='Gráfico historico'></div><span class='menu-text'>Gráfico histórico</span>";if(pie_mode=="simple"){e.className="active menu-button";}else{e.className="menu-button";}e.setAttribute("id","pie_simple");d.appendChild(e);var a=document.createElement("DIV");a.innerHTML="<div class='icon-areas icono' title='Gráfico areas'></div><span class='menu-text'>Gráfico áreas</span>";if(pie_mode=="complex"){a.className="active menu-button";}else{a.className="menu-button";}a.setAttribute("id","pie_complex");d.appendChild(a);var c=document.querySelectorAll("#graph-data")[0];c.innerHTML="";c.appendChild(this.historyPannel());$("#groups-ul").sortable({items:".data-list-li-holder",handle:".data-list-element"});};_.prototype.drawHist=function(a,c){this.ctx=a.getContext("2d");this.data=c;var d=this.getMaxValue();var b=this.createBarsVerticalAxis(d,5,"historico");this.drawHistoricBars(b);clinpt().loadFunctions();};_.prototype.drawHistoricBars=function(f){var l=this.ctx.canvas.width-30;var y=this.ctx.canvas.height-20;var g=l/this.data.length;var G=this.data;var F=-g;var E=this.getMaxValue();var r=this.getMinValue();var v=E-r;var A=[];var c=(f.step*f.numero)*y/E;var z=(f.origen<0)?f.origen:0;this.step=this.getStep(E,5);for(var t=0;t<Object.keys(G[0]).length;t++){if(Object.keys(G[0])[t]!=delim){linea_set=[];F=-g;var q="";if(pie_mode!="simple"){linea_set.push({x:0,y:0});}for(var u=0;u<G.length;u++){try{if(isNaN(G[u][Object.keys(G[0])[t]])){throw"2";}q=((G[u][Object.keys(G[0])[t]]-this.origen)/this.step.label)*this.step.val;linea_set.push({x:F+g,y:-(q)});}catch(B){console.log(B);}F+=g;}if(pie_mode!="simple"){linea_set.push({x:F,y:0});}A.push(linea_set);}}var o=new Kinetic.Layer();var D=this.colores_grupos;for(var u=0;u<A.length;u++){if(pie_mode=="simple"){var k=new Kinetic.Line({points:A[u],stroke:D[u%D.length]["color"],strokeWidth:3,lineCap:"round",lineJoin:"round"});}else{var k=new Kinetic.Polygon({points:A[u],fill:D[u%D.length]["color"],stroke:"white",strokeWidth:1});}k.move(40,y);if(this.printLabels==="true"){var n=Object.keys(G[0])[u+1];var p=this.ctx.measureText(n).width;this.drawLabel(30+A[u][1]["x"],y+A[u][1]["y"]-5,24,D[u%D.length]["color"],"#FFFFFF",n,4,o);}o.add(k);}if(this.separado=="true"){var s=[];F=-g;for(var u=0;u<this.listaSeparador.length;u++){var q=((this.listaSeparador[u]-this.origen)/this.step.label)*this.step.val;s.push({x:F+g,y:-(q)});F+=g;}var d=new Kinetic.Line({points:s,stroke:"white",strokeWidth:2});d.move(40,y);o.add(d);}for(var t=0;t<G.length;t++){var b;if(pie_mode=="simple"){b=35+A[0][t]["x"];}else{b=35+A[0][t+1]["x"]-(this.ctx.measureText(this.data[t][delim]).width/2);}var m=new Kinetic.Text({x:b,y:y,fontSize:12,fontFamily:"Mic 32 New Rounded,mic32newrd,Helvetica,Arial",text:this.data[t][delim],fill:"black",padding:1});o.add(m);}if(this.printLabels==="true"){if(this.separado=="true"){var n=this.separador_title;var p=this.ctx.measureText(n).width;this.drawLabel(60,y-((((this.listaSeparador[0]-r)*y)/v))-10,24,"black","#FFFFFF",n,4,o);}var C=o.find(".label");C.forEach(function(a){a.setZIndex(50);});}this.stage.add(o);o.draw();};_.prototype.draw_history_func=function(o){var q=o.data.separado;var p=o.data.lista;var f=document.querySelectorAll("#fuente_input")[0].value;localStorage.fuente=f;fuente_value=f;var r=document.querySelectorAll("#unidades_input")[0].value;localStorage.unidad=r;unidad_value=r;if(q=="true"){var h=document.querySelectorAll(".data-list-separador");_().each(h,function(e,d){p[e]=d[e].innerHTML;});try{if(typeof p==="string"){throw"Lista Vacia";}var k=p[0];}catch(n){p="";}localStorage.separacionList=JSON.stringify(p);var l=document.querySelector("#separador_text").innerHTML;localStorage.separador_title=l;}var b=[];var c=[];var m=document.querySelectorAll("#groups-ul>li");for(var j=0;j<m[0].children[2].children.length;j++){b.push(new Object);}_().each(m,function(d){var e=m[d].children[1].children[0].innerHTML;c.push(e);_().each(m[d].children[2].children,function(s,i){var t=i[s].children[0].innerHTML;b[s][e]=parseFloat(t);});_().each(m[d].children[2].children,function(s,i){var t=i[s].children[0].innerHTML;b[s][e]=t;});});var g=[];var a=colores_barras;_().each(m,function(e){if(e>0){if(m[e].children[1].children.length>1){var d={grupo:m[e].children[1].children[0].innerHTML,color:m[e].children[1].children[1].children[0].value};}else{var d={grupo:m[e].children[1].children[0].innerHTML,color:a[(e-1)%a.length].hex};}g.push(d);var s=c[e];_().each(m[e].children[2].children,function(t,i){var u=parseFloat(i[t].children[0].innerHTML);b[t][s]=u;});_().each(m[e].children[2].children,function(t,i){var u=parseFloat(i[t].children[0].innerHTML);b[t][s]=u;});}});localStorage.coloresBarras=JSON.stringify(g);localStorage.data=JSON.stringify(b);_().saveStep();_("#graph").history({data:b});};
